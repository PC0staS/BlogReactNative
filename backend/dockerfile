FROM ubuntu:22.04

RUN apt-get update && apt-get install -y \
	python3 python3-pip python3-venv sqlite3 \
	&& rm -rf /var/lib/apt/lists/*

# Create a global venv outside bind mounts
RUN python3 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Install dependencies into venv
WORKDIR /tmp/build
COPY code/requirements.txt ./requirements.txt
RUN pip install --upgrade pip && pip install -r requirements.txt

# Copy code (will be overridden by volume in dev, but OK)
WORKDIR /app/code
COPY code/ ./
WORKDIR /app
COPY db/ ./db

# Expose container port 3000 (compose maps 3001 -> 3000)
EXPOSE 3000

WORKDIR /app/code
# Use flask run with reload in development so code changes in the mounted volume are picked up
CMD ["flask", "--app", "app", "run", "--host=0.0.0.0", "--port=3000", "--reload"]
